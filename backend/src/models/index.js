const { Sequelize } = require('sequelize');
const User = require('./User');
const Article = require('./Article');
const Comment = require('./Comment');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ SQLite
const sequelize = new Sequelize({
  dialect: 'sqlite',
  storage: './travelpoint.db',
  logging: false
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π
User.initModel(sequelize);
Article.initModel(sequelize);
Comment.initModel(sequelize);

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤—è–∑–µ–π
User.hasMany(Article, { foreignKey: 'authorId', as: 'Articles' });
Article.belongsTo(User, { foreignKey: 'authorId', as: 'User' });

User.hasMany(Comment, { foreignKey: 'userId', as: 'Comments' });
Comment.belongsTo(User, { foreignKey: 'userId', as: 'User' });

Article.hasMany(Comment, { foreignKey: 'articleId', as: 'Comments' });
Comment.belongsTo(Article, { foreignKey: 'articleId', as: 'Article' });

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const createTestUsers = async () => {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    const userCount = await User.count();
    
    if (userCount === 0) {
      // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      const bcrypt = require('bcryptjs');
      
      const admin = await User.create({
        email: 'admin@test.com',
        password: await bcrypt.hash('admin123', 10),
        name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        role: 'ADMIN'
      });
      
      const user = await User.create({
        email: 'user@test.com',
        password: await bcrypt.hash('user123', 10),
        name: '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        role: 'USER'
      });
      
      console.log(' –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞–Ω—ã');
      console.log(`   üëë –ê–¥–º–∏–Ω: ${admin.email} / admin123`);
      console.log(`   üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.email} / user123`);
      
      return { admin, user };
    }
    
    return null;
  } catch (error) {
    console.error(' –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
    return null;
  }
};

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π
const createTestArticles = async () => {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å—Ç–∞—Ç—å–∏
    const articleCount = await Article.count();
    
    if (articleCount === 0) {
      const admin = await User.findOne({ where: { email: 'admin@test.com' } });
      
      if (admin) {
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ç–∞—Ç—å–∏
        const articles = [
          {
            title: '–¢–æ–ø-10 –º–µ—Å—Ç –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è –≤ –Ø–ø–æ–Ω–∏–∏ –≤–µ—Å–Ω–æ–π',
            content: '–í–µ—Å–Ω–∞ –≤ –Ø–ø–æ–Ω–∏–∏ - —ç—Ç–æ –≤—Ä–µ–º—è —Ü–≤–µ—Ç–µ–Ω–∏—è —Å–∞–∫—É—Ä—ã –∏ –Ω–µ–∑–∞–±—ã–≤–∞–µ–º—ã—Ö –ø–µ–π–∑–∞–∂–µ–π. –û—Ç —Ç–æ–∫–∏–π—Å–∫–∏—Ö –ø–∞—Ä–∫–æ–≤ –¥–æ –∫–∏–æ—Ç—Å–∫–∏—Ö —Ö—Ä–∞–º–æ–≤ - –∫–∞–∂–¥—ã–π —É–≥–æ–ª–æ–∫ —Å—Ç—Ä–∞–Ω—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∂–∏–≤—É—é –∫–∞—Ä—Ç–∏–Ω—É. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ—Å–µ—Ç–∏—Ç—å –ø–∞—Ä–∫ –£—ç–Ω–æ –≤ –¢–æ–∫–∏–æ, –∑–∞–º–æ–∫ –•–∏–º—ç–¥–∑–∏ –∏ –±–∞–º–±—É–∫–æ–≤—É—é —Ä–æ—â—É –ê—Ä–∞—Å–∏—è–º–∞ –≤ –ö–∏–æ—Ç–æ.',
            excerpt: '–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –ª—É—á—à–∏–µ –º–µ—Å—Ç–∞ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è –≤ –Ø–ø–æ–Ω–∏–∏ –≤ —Å–µ–∑–æ–Ω —Ü–≤–µ—Ç–µ–Ω–∏—è —Å–∞–∫—É—Ä—ã.',
            imageUrl: '/images/japan-spring.jpg',
            category: '–ê–∑–∏—è',
            readTime: 8,
            views: 42,
            likes: 15,
            authorId: admin.id
          },
          {
            title: '–ö–∞–∫ –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å –±—é–¥–∂–µ—Ç–Ω–æ –ø–æ –ï–≤—Ä–æ–ø–µ',
            content: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø–æ –ï–≤—Ä–æ–ø–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Ä–æ–≥–∏–º. –í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–≤–µ—Ç–æ–≤: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∞–≤—Ç–æ–±—É—Å—ã –≤–º–µ—Å—Ç–æ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö, –≤—ã–±–∏—Ä–∞–π—Ç–µ –∂–∏–ª—å–µ —á–µ—Ä–µ–∑ Airbnb –≤ –ø—Ä–∏–≥–æ—Ä–æ–¥–∞—Ö, –ø–æ–∫—É–ø–∞–π—Ç–µ –µ–¥—É –≤ —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç–∞—Ö –∏ –≥–æ—Ç–æ–≤—å—Ç–µ —Å–∞–º–∏. –¢–∞–∫–∂–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –≤ –º–µ–∂—Å–µ–∑–æ–Ω—å–µ.',
            excerpt: '–°–µ–∫—Ä–µ—Ç—ã –±—é–¥–∂–µ—Ç–Ω—ã—Ö –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –ø–æ –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–º —Å—Ç—Ä–∞–Ω–∞–º.',
            imageUrl: '/images/europe-budget.jpg',
            category: '–ï–≤—Ä–æ–ø–∞',
            readTime: 6,
            views: 28,
            likes: 8,
            authorId: admin.id
          },
          {
            title: '–°–∫—Ä—ã—Ç—ã–µ –ø–ª—è–∂–∏ –¢–∞–∏–ª–∞–Ω–¥–∞',
            content: '–ó–∞–±—É–¥—å—Ç–µ –æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ø–ª—è–∂–∞—Ö. –≠—Ç–∏ –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–ª–∏—Å—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º–∏: –ø–ª—è–∂ Freedom Beach –Ω–∞ –ü—Ö—É–∫–µ—Ç–µ, –æ—Å—Ç—Ä–æ–≤ –ö–æ –õ–∏–ø–µ –Ω–∞ —é–≥–µ, –∏ –ø–ª—è–∂ –ú–∞–π–∞ –ë—ç–π, –∫–æ—Ç–æ—Ä—ã–π —Å–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã—Ç –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã.',
            excerpt: '–û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–∞–º—ã–µ –∫—Ä–∞—Å–∏–≤—ã–µ –∏ –º–∞–ª–æ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–ª—è–∂–∏ –¢–∞–∏–ª–∞–Ω–¥–∞.',
            imageUrl: '/images/thailand.jpg',
            category: '–ê–∑–∏—è',
            readTime: 7,
            views: 35,
            likes: 12,
            authorId: admin.id
          },
          {
            title: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø–æ –ó–æ–ª–æ—Ç–æ–º—É –∫–æ–ª—å—Ü—É –†–æ—Å—Å–∏–∏',
            content: '–ó–æ–ª–æ—Ç–æ–µ –∫–æ–ª—å—Ü–æ –†–æ—Å—Å–∏–∏ - —ç—Ç–æ –º–∞—Ä—à—Ä—É—Ç –ø–æ –¥—Ä–µ–≤–Ω–∏–º –≥–æ—Ä–æ–¥–∞–º, —Ö—Ä–∞–Ω—è—â–∏–º –∏—Å—Ç–æ—Ä–∏—é –∏ –∫—É–ª—å—Ç—É—Ä—É —Å—Ç—Ä–∞–Ω—ã. –°–µ—Ä–≥–∏–µ–≤ –ü–æ—Å–∞–¥, –ü–µ—Ä–µ—Å–ª–∞–≤–ª—å-–ó–∞–ª–µ—Å—Å–∫–∏–π, –†–æ—Å—Ç–æ–≤ –í–µ–ª–∏–∫–∏–π, –Ø—Ä–æ—Å–ª–∞–≤–ª—å, –ö–æ—Å—Ç—Ä–æ–º–∞, –ò–≤–∞–Ω–æ–≤–æ, –°—É–∑–¥–∞–ª—å –∏ –í–ª–∞–¥–∏–º–∏—Ä - –∫–∞–∂–¥—ã–π –≥–æ—Ä–æ–¥ —É–Ω–∏–∫–∞–ª–µ–Ω.',
            excerpt: '–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫—Ä–∞—Å–æ—Ç—É –¥—Ä–µ–≤–Ω–µ—Ä—É—Å—Å–∫–∏—Ö –≥–æ—Ä–æ–¥–æ–≤ –ó–æ–ª–æ—Ç–æ–≥–æ –∫–æ–ª—å—Ü–∞.',
            imageUrl: '/images/russia-golden-ring.jpg',
            category: '–†–æ—Å—Å–∏—è',
            readTime: 10,
            views: 50,
            likes: 20,
            authorId: admin.id
          },
          {
            title: '–ì–æ—Ä–Ω—ã–µ –ø–æ—Ö–æ–¥—ã –≤ –ê–ª—å–ø–∞—Ö –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤',
            content: '–ê–ª—å–ø—ã –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –ª—é–±–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏. –î–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ç—Ä–æ–ø—ã –≤–æ–∫—Ä—É–≥ –æ–∑–µ—Ä–∞ –ê–Ω—Å–∏ –≤–æ –§—Ä–∞–Ω—Ü–∏–∏, –¥–æ–ª–∏–Ω—É –¶–∏–ª–ª–µ—Ä—Ç–∞–ª—å –≤ –ê–≤—Å—Ç—Ä–∏–∏ –∏–ª–∏ —Ä–µ–≥–∏–æ–Ω –Æ–Ω–≥—Ñ—Ä–∞—É –≤ –®–≤–µ–π—Ü–∞—Ä–∏–∏. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —ç–∫–∏–ø–∏—Ä–æ–≤–∫—É!',
            excerpt: '–õ—É—á—à–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Ö–æ–¥–∞ –≤ –ê–ª—å–ø–∞—Ö.',
            imageUrl: '/images/alps-hiking.jpg',
            category: '–ï–≤—Ä–æ–ø–∞',
            readTime: 9,
            views: 31,
            likes: 10,
            authorId: admin.id
          }
        ];
        
        await Article.bulkCreate(articles);
        console.log(' –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ç–∞—Ç—å–∏ —Å–æ–∑–¥–∞–Ω—ã (5 —Å—Ç–∞—Ç–µ–π)');
        
        return articles;
      }
    }
    
    return null;
  } catch (error) {
    console.error(' –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π:', error);
    return null;
  }
};

// –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
const syncDatabase = async () => {
  try {
    await sequelize.sync({ force: false });
    console.log(' –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    
    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    await createTestUsers();
    
    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ç–∞—Ç—å–∏
    await createTestArticles();
    
    return true;
  } catch (error) {
    console.error(' –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ë–î:', error);
    return false;
  }
};

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –∏–∑ –º–æ–¥–µ–ª–µ–π (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
if (User.associate) {
  User.associate({ User, Article, Comment });
}
if (Article.associate) {
  Article.associate({ User, Article, Comment });
}
if (Comment.associate) {
  Comment.associate({ User, Article, Comment });
}

// –≠–∫—Å–ø–æ—Ä—Ç—ã
module.exports = {
  sequelize,
  User,
  Article,
  Comment,
  syncDatabase
};